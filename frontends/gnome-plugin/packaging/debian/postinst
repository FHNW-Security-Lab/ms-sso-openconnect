#!/bin/bash
set -e

case "$1" in
    configure)
        echo "Setting up MS SSO OpenConnect VPN plugin..."

        # Install playwright Python package system-wide
        echo "Checking playwright installation..."
        if ! python3 -c "import playwright" 2>/dev/null; then
            echo "Installing playwright Python package..."
            pip3 install --break-system-packages playwright || \
            pip3 install playwright || {
                echo "ERROR: Could not install playwright via pip."
                echo "Please run manually: sudo pip3 install playwright"
                exit 1
            }
        else
            echo "Playwright Python package already installed."
        fi

        # Always install chromium browser for playwright (uses python3 -m to ensure correct module)
        echo "Installing Chromium browser for playwright (this may take a few minutes)..."
        # Use python3 -m playwright to ensure we use the correct module
        # Install with --with-deps to get system dependencies
        python3 -m playwright install chromium --with-deps || \
        python3 -m playwright install chromium || {
            echo "ERROR: Could not install Chromium browser for playwright."
            echo "Please run manually: sudo python3 -m playwright install chromium --with-deps"
            exit 1
        }
        echo "Chromium browser installed successfully."

        # Restart NetworkManager to pick up the new plugin
        if systemctl is-active --quiet NetworkManager; then
            echo "Restarting NetworkManager..."
            systemctl restart NetworkManager || true
        fi
        ;;

    abort-upgrade|abort-remove|abort-deconfigure)
        ;;

    *)
        ;;
esac

#DEBHELPER#

exit 0
