#!/bin/bash
#
# MS SSO OpenConnect - Wrapper script
# Uses headless browser to handle Microsoft SSO authentication for OpenConnect VPN
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="$SCRIPT_DIR/venv"
PYTHON_SCRIPT="$SCRIPT_DIR/ms-sso-openconnect.py"

# Get the real user (even when running with sudo)
REAL_USER="${SUDO_USER:-$USER}"
if [[ "$OSTYPE" == "darwin"* ]]; then
    REAL_HOME=$(dscl . -read /Users/"$REAL_USER" NFSHomeDirectory 2>/dev/null | awk '{print $2}')
else
    REAL_HOME=$(getent passwd "$REAL_USER" | cut -d: -f6)
fi
# Fallback to $HOME if lookup failed
REAL_HOME="${REAL_HOME:-$HOME}"

# Use the real user's playwright cache
export PLAYWRIGHT_BROWSERS_PATH="$REAL_HOME/.cache/ms-playwright"

# Pass through DBUS for keyring access when running as root
if [ -n "$SUDO_USER" ]; then
    export DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/$(id -u $REAL_USER)/bus"
fi

# Prefer uv if available, fall back to pip
if command -v uv &>/dev/null; then
    PIP_INSTALL="uv pip install --python $VENV_DIR/bin/python"
    VENV_CREATE="uv venv $VENV_DIR"
else
    PIP_INSTALL="$VENV_DIR/bin/pip install -q"
    VENV_CREATE="python3 -m venv $VENV_DIR"
fi

if [ ! -d "$VENV_DIR" ]; then
    echo "Creating Python virtual environment..."
    $VENV_CREATE
    $PIP_INSTALL playwright keyring pyotp
    [[ "$OSTYPE" == "linux"* ]] && $PIP_INSTALL secretstorage
    "$VENV_DIR/bin/playwright" install chromium
elif ! "$VENV_DIR/bin/python" -c "import keyring, pyotp" 2>/dev/null; then
    echo "Installing additional dependencies..."
    $PIP_INSTALL keyring pyotp
    [[ "$OSTYPE" == "linux"* ]] && $PIP_INSTALL secretstorage
fi


# Check for openconnect (only needed when connecting)
needs_openconnect=true
# Check for openconnect during setup
for arg in "$@"; do
    case "$arg" in
        --setup|-s)
            if ! command -v openconnect &>/dev/null; then
                echo "Warning: openconnect is not installed."
                if [[ "$OSTYPE" == "darwin"* ]]; then
                    echo "Install with: brew install openconnect"
                elif command -v apt &>/dev/null; then
                    echo "Install with: sudo apt install openconnect"
                elif command -v dnf &>/dev/null; then
                    echo "Install with: sudo dnf install openconnect"
                elif command -v pacman &>/dev/null; then
                    echo "Install with: sudo pacman -S openconnect"
                fi
                echo ""
            fi
            break
            ;;
    esac
done

# Run the Python script with venv
exec "$VENV_DIR/bin/python" "$PYTHON_SCRIPT" "$@"
