#!/bin/bash
set -e

VENV_DIR="/opt/ms-sso-openconnect-nm/venv"
PLAYWRIGHT_BROWSERS="/opt/ms-sso-openconnect-nm/browsers"

case "$1" in
    configure)
        echo "Setting up NetworkManager MS SSO OpenConnect plugin..."

        if [ ! -x "$VENV_DIR/bin/python" ]; then
            echo "Creating Python virtual environment..."
            mkdir -p /opt/ms-sso-openconnect-nm
            python3 -m venv "$VENV_DIR"
        fi

        echo "Installing Playwright + pyotp..."
        "$VENV_DIR/bin/pip" install --quiet --upgrade pip setuptools wheel
        "$VENV_DIR/bin/pip" install --quiet playwright pyotp

        echo "Installing Chromium browser for SSO authentication..."
        PLAYWRIGHT_BROWSERS_PATH="$PLAYWRIGHT_BROWSERS" "$VENV_DIR/bin/playwright" install chromium

        echo "Done."
        ;;
esac

#DEBHELPER#

exit 0

