#!/usr/bin/env python3
"""Authentication dialog for NetworkManager ms-sso-openconnect VPN plugin.

NetworkManager calls this helper when secrets are required and interactive
authentication is allowed. The dialog collects:
- password
- TOTP secret (base32)

Secrets are printed to stdout in key=value form and terminated by a line with
just "--" as expected by NetworkManager.
"""

from __future__ import annotations

import argparse
import sys
from dataclasses import dataclass

import gi

gi.require_version("Gtk", "4.0")
from gi.repository import Gtk  # noqa: E402


@dataclass
class Secrets:
    password: str
    totp_secret: str


class AuthApp(Gtk.Application):
    def __init__(self, title: str):
        super().__init__(application_id="org.freedesktop.NetworkManager.ms_sso_openconnect_auth")
        self._title = title
        self.secrets: Secrets | None = None

    def do_activate(self) -> None:  # type: ignore[override]
        window = Gtk.ApplicationWindow(application=self, title=self._title)
        window.set_default_size(520, 220)

        root = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=12)
        root.set_margin_top(12)
        root.set_margin_bottom(12)
        root.set_margin_start(12)
        root.set_margin_end(12)

        grid = Gtk.Grid(column_spacing=12, row_spacing=12)

        password_label = Gtk.Label(label="Password")
        password_label.set_halign(Gtk.Align.START)
        password_entry = Gtk.PasswordEntry()
        password_entry.set_hexpand(True)

        totp_label = Gtk.Label(label="TOTP Secret")
        totp_label.set_halign(Gtk.Align.START)
        totp_entry = Gtk.PasswordEntry()
        totp_entry.set_hexpand(True)

        grid.attach(password_label, 0, 0, 1, 1)
        grid.attach(password_entry, 1, 0, 1, 1)
        grid.attach(totp_label, 0, 1, 1, 1)
        grid.attach(totp_entry, 1, 1, 1, 1)

        buttons = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=12)
        buttons.set_halign(Gtk.Align.END)

        cancel_btn = Gtk.Button(label="Cancel")
        ok_btn = Gtk.Button(label="Connect")
        ok_btn.add_css_class("suggested-action")

        def on_cancel(_btn: Gtk.Button) -> None:
            self.secrets = None
            self.quit()

        def on_ok(_btn: Gtk.Button) -> None:
            password = password_entry.get_text().strip()
            totp = totp_entry.get_text().strip()
            if not password or not totp:
                return
            self.secrets = Secrets(password=password, totp_secret=totp)
            self.quit()

        cancel_btn.connect("clicked", on_cancel)
        ok_btn.connect("clicked", on_ok)

        buttons.append(cancel_btn)
        buttons.append(ok_btn)

        root.append(grid)
        root.append(buttons)
        window.set_child(root)
        window.present()


def _read_hints() -> dict[str, str]:
    hints: dict[str, str] = {}
    for line in sys.stdin:
        line = line.strip()
        if not line or line == "--":
            break
        if "=" not in line:
            continue
        key, value = line.split("=", 1)
        hints[key] = value
    return hints


def main() -> int:
    parser = argparse.ArgumentParser(description="MS SSO OpenConnect auth dialog (NetworkManager)")
    parser.add_argument("-u", "--uuid", help="Connection UUID")
    parser.add_argument("-n", "--name", help="Connection name")
    parser.add_argument("-s", "--service", help="VPN service type")
    parser.add_argument("-i", "--allow-interaction", action="store_true", help="Allow user interaction")
    parser.add_argument("--external-ui-mode", action="store_true", help="External UI mode")
    parser.add_argument("--reprompt", action="store_true", help="Re-prompt for secrets")
    _args, _unknown = parser.parse_known_args()

    _read_hints()

    if not _args.allow_interaction:
        return 1

    title = _args.name or "VPN Authentication"
    app = AuthApp(title=title)
    app.run(None)

    if not app.secrets:
        return 1

    # Print secrets for NetworkManager
    print(f"password={app.secrets.password}")
    print(f"totp-secret={app.secrets.totp_secret}")
    print("--")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())

